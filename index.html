<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agente de Viajes </title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <!-- Modal de llaves -->
  <div id="keysModal" class="modal visible">
    <div class="modal-card">
      <h2>Configura tus API Keys</h2>
      <p class="muted">Se guardan en tu navegador (sessionStorage) y se env√≠an por HTTPS cuando solicitas itinerarios/chat. No se persisten en el servidor.</p>
      <label>GROQ_API_KEY</label>
      <input id="groqKey" type="password" placeholder="gsk_..." />
      <label>SERPAPI_API_KEY (opcional)</label>
      <input id="serpKey" type="password" placeholder="xxxxxx" />
      <button id="saveKeys">Guardar y continuar</button>
    </div>
  </div>

  <header>
    <h1>‚úàÔ∏è Agente de Viajes</h1>
    <div class="controls">
      <button id="openKeys">üîê API Keys</button>
      <a href="/api/health" target="_blank" class="link">health</a>
    </div>
  </header>

  <main>
    <section class="planner">
      <h2>Crear itinerario</h2>
      <form id="planForm">
        <div class="row">
          <label>Destino</label>
          <input name="city" placeholder="Ej. Medell√≠n" required />
        </div>
        <div class="row">
          <label>D√≠as</label>
          <input name="days" type="number" min="1" max="14" value="3" required />
        </div>
        <div class="row">
          <label>Fecha de inicio (opcional)</label>
          <input name="start_date" type="date" />
        </div>
        <div class="row">
          <label>Idioma</label>
          <select name="language">
            <option value="es" selected>Espa√±ol</option>
            <option value="en">English</option>
          </select>
        </div>
        <button type="submit">üöÄ Generar</button>
      </form>
      <div id="planOutput" class="card hidden"></div>
      <div id="downloadBtns" class="row hidden">
        <button id="dlTxt">‚¨áÔ∏è Descargar .txt</button>
        <button id="dlIcs">‚¨áÔ∏è Descargar .ics</button>
      </div>
    </section>

    <section class="chat">
      <h2>Chat</h2>
      <div id="chatBox" class="chat-box"></div>
      <form id="chatForm" class="chat-form">
        <input id="chatInput" placeholder="Escribe tu solicitud de viaje..." />
        <button>Enviar</button>
      </form>
    </section>
  </main>

  <footer>
    <small>Hecho con FastAPI + Groq + SerpAPI en Vercel.</small>
  </footer>

  <script>
    const $ = (sel) => document.querySelector(sel);

    // Keys en sessionStorage
    const keysModal = $('#keysModal');
    const groqInput = $('#groqKey');
    const serpInput = $('#serpKey');
    const getGroq = () => sessionStorage.getItem('GROQ_API_KEY') || '';
    const setGroq = (v) => sessionStorage.setItem('GROQ_API_KEY', v);
    const getSerp = () => sessionStorage.getItem('SERPAPI_API_KEY') || '';
    const setSerp = (v) => sessionStorage.setItem('SERPAPI_API_KEY', v);

    $('#saveKeys').onclick = () => {
      const g = groqInput.value.trim();
      if(!g){ alert('Ingresa tu GROQ_API_KEY'); return; }
      setGroq(g);
      setSerp(serpInput.value.trim());
      keysModal.classList.remove('visible');
    };
    $('#openKeys').onclick = () => { keysModal.classList.add('visible'); };

    // --- Chat ---
    const chatBox = $('#chatBox');
    const chatForm = $('#chatForm');
    const chatInput = $('#chatInput');
    let history = [];

    function addMsg(role, text){
      const el = document.createElement('div');
      el.className = 'msg ' + role;
      el.textContent = text;
      chatBox.appendChild(el);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if(!text) return;
      addMsg('user', text);
      chatInput.value='';

      const payload = {
        keys: { groq_api_key: getGroq(), serpapi_api_key: getSerp() || null },
        message: text,
        history,
      };

      const res = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const data = await res.json().catch(()=>({message:'Error de red'}));

      if(data.type === 'need_prefs'){
        addMsg('assistant', data.message + ' (usa el formulario de itinerario a la izquierda)');
        return;
      }
      if(data.type === 'need_city'){
        addMsg('assistant', data.message + ' (escribe el nombre de la ciudad)');
        return;
      }
      if(data.type === 'itinerary'){
        addMsg('assistant', data.message);
        renderItinerary(data.itinerary);
        return;
      }
      addMsg('assistant', data.message || 'Listo.');
      history.push({ role: 'user', content: text });
      history.push({ role: 'assistant', content: data.message || '' });
    });

    // --- Planner ---
    const planForm = $('#planForm');
    const planOutput = $('#planOutput');
    const downloadBtns = $('#downloadBtns');
    let lastItinerary = null;

    function renderItinerary(it){
      lastItinerary = it;
      let html = `<h3>Itinerario ‚Äî ${it.location}</h3><p class="muted">${it.weather_overview}</p>`;
      html += '<ol class="days">';
      for(const d of it.days){
        html += `<li><h4>${d.date} ¬∑ ${d.title}</h4>
          <p><b>Ma√±ana:</b> ${d.morning}</p>
          <p><b>Tarde:</b> ${d.afternoon}</p>
          <p><b>Noche:</b> ${d.evening}</p>
          ${d.notes ? `<p><i>${d.notes}</i></p>`: ''}
        </li>`;
      }
      html += '</ol>';
      planOutput.innerHTML = html;
      planOutput.classList.remove('hidden');
      downloadBtns.classList.remove('hidden');
    }

    planForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(planForm);
      const city = form.get('city');
      const days = parseInt(form.get('days'), 10);
      const start_date = form.get('start_date');
      const language = form.get('language') || 'es';

      const body = {
        groq_api_key: getGroq(),
        serpapi_api_key: getSerp() || null,
        city, days, start_date, language
      };
      const res = await fetch('/api/itinerary', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if(!res.ok){
        const err = await res.json().catch(()=>({detail:'Error desconocido'}));
        alert('Error: ' + (err.detail || res.status));
        return;
      }
      const it = await res.json();
      renderItinerary(it);
      addMsg('assistant', `Gener√© tu itinerario para ${city}. ¬°Revisa la tarjeta!`);
    });

    // --- Descargas ---
    async function triggerDownload(endpoint, filenameFallback){
      if(!lastItinerary){ alert('Primero genera un itinerario.'); return; }
      const res = await fetch(endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(lastItinerary) });
      const data = await res.json();
      const blob = new Blob([data.content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = data.filename || filenameFallback;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    $('#dlTxt').onclick = () => triggerDownload('/api/download/txt', 'itinerario.txt');
    $('#dlIcs').onclick = () => triggerDownload('/api/download/ics', 'itinerario.ics');

    // Abre modal si no hay key
    window.addEventListener('load', ()=>{ if(!getGroq()) keysModal.classList.add('visible'); });
  </script>
</body>
</html>
